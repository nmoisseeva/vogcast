#!/usr/bin/python3.7

# Setup environment for the vog model run
#
__author__='Nadya Moisseeva (nadya.moisseeva@hawaii.edu)'
__date__='July 2021'

 ### Inputs ###
#TODO This CANNOT be hardcoded: provide as mandatory input option
config_path = '../vog.config' 		#json config file (assumed vog_root location)

#import supporting modules
import sys
sys.path.append('.')
from set_vog_env import *
import os
import logging
import conv_arl, run_plumerise, get_hvo_emissions, run_dispersion

#set up logging
logging.basicConfig(level=logging.DEBUG,format='%(asctime)s %(message)s', datefmt='[%Y-%m-%d %H:%M:%S %Z]')


### Main ###
if __name__ == '__main__':
	logging.info('BEGIN VOG PIPELINE RUN')
	
	#read date input and determine run typ
	args = parse_inputs()				
	if args.date:
		rundate = args.date
		logging.info('Performing historic run for: %s%s' %(rundate, args.cycle))	
	else:
		rundate = datetime.datetime.now().strftime('%Y%m%d')	
		logging.info('Performing real-time run for: %s%s' %(rundate,args.cycle))	
	forecast = '%s%s' %(rundate,args.cycle)
	os.environ['forecast'] = forecast

	#load configuration settings
	settings = read_config(config_path)

	#set shared environmental variables
	set_env_var(settings, 'vog_root')
	set_env_var(settings, 'run_dir')
	set_env_var(settings, 'runhrs')
	os.environ['config_path'] = os.path.join(os.environ['vog_root'], 'vog.config')

	#set full run path
	os.environ['run_path'] = os.path.join(os.environ['run_dir'],forecast)

	#set variables for met modules
	# includes: get_nam, run_wps, run_wrf
	#TODO: combine into single python met module
	set_env_var(settings['met'], 'max_dom')
	set_env_var(settings['met'], 'ibc_path')
	set_env_var(settings['met'], 'wps_path')
	set_env_var(settings['met'], 'wrf_path')


	#set vertiables for dispersion
	#includes: conv_arl, run_dispersion
	set_env_var(settings['dispersion'], 'hys_path')
	set_env_var(settings['dispersion'], 'spinup')
	os.environ['hys_rundir'] = os.path.join(os.environ['run_path'],'hysplit')
	
	#create storage folders and pipeline json
	create_run_dir()
	json_path = create_run_json(config_path)
	os.environ['json_path'] = json_path

	#download initial conditions
	os.system('bash ./get_nam -d %s %s' %(rundate,args.cycle))
	logging.info('Completed IBC download')
	
	#run wps
	os.system('bash ./run_wps -d %s %s' %(rundate,args.cycle))
	logging.info('Completed WPS run')
	
	#run wrf
	os.system('bash ./run_wrf -d %s %s' %(rundate,args.cycle))
	logging.info('Completed WRF run')

	#convert wrf to arl files
	conv_arl.main()

	#update emissions
	get_hvo_emissions.main()

	#calculate plume rise
	run_plumerise.main()

	#run dispersion
	run_dispersion.main()
	
	#run graphics

	#run archiving
